import json
import random

import disnake
from disnake import TextInputStyle
from disnake.ext import commands

def add_to_welcome_json(key, value):
    with open("./data/welcome.json", "r", encoding="utf-8") as f:
        c_data = json.load(f)
        c_data[key] = value

    with open("./data/welcome.json", "w", encoding="utf-8") as f:
        json.dump(c_data, f)


def get_welcome_value(key):
    with open("./data/welcome.json", "r", encoding="utf-8") as f:
        c_data = json.load(f)
        return c_data[key]

senders = {}

def settingsWelcomeEmbed():
    embed = disnake.Embed(
        title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è",
        description=f"**–¢–∏—Ç—É–ª:** ``{get_welcome_value('title')}`` \n **–û–ø–∏—Å–∞–Ω–∏–µ: \n** ```{get_welcome_value('description')}``` \n **–ö–∞–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:** <#{str(get_welcome_value('channel_id'))}> \n **–ö–∞—Ä—Ç–∏–Ω–∫–∞:** ``–Ω–∏–∂–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏``"
    )
    embed.set_image(url=get_welcome_value("image"))
    return embed

class WelcomeSettingsModal(disnake.ui.Modal):
    def __init__(self):
        components = [
            disnake.ui.TextInput(
                label="–¢–∏—Ç—É–ª",
                value=get_welcome_value("title"),
                custom_id="title",
                style=TextInputStyle.short,
                required=False,
            ),
            disnake.ui.TextInput(
                label="–û–ø–∏—Å–∞–Ω–∏–µ",
                value=get_welcome_value("description"),
                custom_id="description",
                style=TextInputStyle.paragraph,
                required=False,
            ),
            disnake.ui.TextInput(
                label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É",
                placeholder="...",
                value=get_welcome_value("image"),
                custom_id="image",
                style=TextInputStyle.short,
                required=False,
            ),
        ]
        super().__init__(title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏", components=components)

    async def callback(self, inter: disnake.ModalInteraction):
        for key, value in inter.text_values.items():
            if value != '':
                add_to_welcome_json(key, value)

        await inter.message.edit(embeds=[settingsWelcomeEmbed()])
        await inter.response.send_message("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω—ã.", ephemeral=True)


class Welcome(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @commands.slash_command(name="welcomesettings", description="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π", dm_permission=False)
    @commands.default_member_permissions(administrator=True)
    async def welcomesettings(self, inter):
        if get_welcome_value("off") == True:
            offbtn = disnake.ui.Button(label="–í–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è", style=disnake.ButtonStyle.success, custom_id="offbtn")
        else:
            offbtn = disnake.ui.Button(label="–û—Ç–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è", style=disnake.ButtonStyle.danger, custom_id="offbtn")
        await inter.response.send_message(embeds=[settingsWelcomeEmbed()], components=[disnake.ui.ChannelSelect(custom_id="welcomechannelselect", placeholder="–ö–∞–Ω–∞–ª"), disnake.ui.Button(label="–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", style=disnake.ButtonStyle.gray, custom_id="changewelcomesettings"), offbtn])

    @commands.Cog.listener("on_button_click")
    async def button_listener(self, inter: disnake.MessageInteraction):
        if inter.component.custom_id not in ["changewelcomesettings", "offbtn"]:
            return
        
        if inter.component.custom_id == "changewelcomesettings":
            await inter.response.send_modal(modal=WelcomeSettingsModal())
        elif inter.component.custom_id == "offbtn":
            add_to_welcome_json("off", not get_welcome_value("off"))
            await inter.response.send_message("–£—Å–ø–µ—à–Ω–æ", ephemeral=True)
            if get_welcome_value("off") == True:
                offbtn = disnake.ui.Button(label="–í–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è", style=disnake.ButtonStyle.success, custom_id="offbtn")
            else:
                offbtn = disnake.ui.Button(label="–û—Ç–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è", style=disnake.ButtonStyle.danger, custom_id="offbtn")
            await inter.message.edit(embeds=[settingsWelcomeEmbed()], components=[disnake.ui.ChannelSelect(custom_id="welcomechannelselect", placeholder="–ö–∞–Ω–∞–ª"), disnake.ui.Button(label="–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", style=disnake.ButtonStyle.gray, custom_id="changesettings"), offbtn])
    
    @commands.Cog.listener("on_dropdown")
    async def dropdown_listener(self, inter: disnake.MessageInteraction):
        if inter.component.custom_id not in ["welcomechannelselect"]:
            return

        if inter.component.custom_id == "welcomechannelselect":
            selected_value = inter.values[0]
            try:
                add_to_welcome_json("channel_id", int(selected_value))
                await inter.response.send_message("–ö–∞–Ω–∞–ª –±—ã–ª –ø–µ—Ä–µ–≤—ã–±—Ä–∞–Ω", ephemeral=True)
                await inter.message.edit(embeds=[settingsWelcomeEmbed()])
            except Exception as ex:
                await inter.response.send_message(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (–∫–æ–¥: ``{ex}``). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. \n–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ `_thecoffee_`.", ephemeral=True)
    

    @commands.Cog.listener("on_member_join")
    async def on_member_join(self, member):
        if get_welcome_value("off") == False:
            channel = self.bot.get_channel(get_welcome_value("channel_id"))
            footers = ["üîó discord.gg/cmt-minecraft", "üéÆ play.cmt-minecraft.ru"]
            footer_rng = random.randint(0, len(footers) - 1)
            footer = footers[footer_rng]
            embed = disnake.Embed(
                title=get_welcome_value("title"),
                description=get_welcome_value("description"),
            )
            embed.set_footer(
                text=footer,
            )
            embed.set_image(url=get_welcome_value("image"))
            await channel.send(embeds=[embed], content=f"<@{member.id}>")

            

def setup(bot: commands.Bot):
    bot.add_cog(Welcome(bot))